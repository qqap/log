<link rel="stylesheet" href="../style.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../default.css">
<script src="../highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<title>Theming in Chromium</title>

<div class="main">
<h1>Theming in Chromium</h1>

<style type="text/css">
mark {
    background:yellow;
    color:gray;
}
mark span {
    background:inherit;
    color:inherit;
}
</style>

<p>
One day I was using Safari and noticed that they change the titlebar color based on the website. I discovered that there's a special tag called <code>theme-color</code> that the website can define to change it. Even Chrome for Android, Safari on iOS, and Samsung internet do it, however only Safari was doing it for desktop. 
</p>

<p>It seemed fancy, and I wanted to to have it for Chromium desktop, so I decided to implement it. The first thought was to create a patch to Chromium, and in hindsight there might have been easier ways to do it with a browser extension, but oh well, I already started cloning the entire repo.
</p>
<p>
How to get & compile Chromium? Google has a guide. Chromium has this <code>gclient</code> thing which is Google's custom way of managing modular dependencies. Sounds similar to git submodules? Yes, in fact Google is trying to replace gclient with standard git submodules soon. Anyway, so I used <code>gclient</code> to fetch the code, which took a day or two, and then compiled it with the Ninja build system.
</p>

<p>
I somehow ended up using 100GB of storage at the end, so I deleted half of my system for this. Must be all those object files. Note that once you compile the dev build, they are a bit slow to run at times.
</p>

<video  style="width:min(80%, 500px)" muted loop src="https://media.guptaditya.com/theme.mp4" type="video/mp4" >
</video>

    <script> 
  
        let clip = document.querySelector("video") 
  
        clip.addEventListener("mouseover", function (e) { 
            clip.play(); 
        }) 
 
        clip.addEventListener("mouseout", function (e) { 
            clip.pause(); 
        }) 
    </script> 

<p>After digging through the code for hours, I found this place to get the color for the <code>BrowserFrame</code> in <code>ui/views/frame/browser_frame.cc</code> and extracted the web contents from the active tab to get the theme color and return it. You also need to enable the <code>#chrome-refresh-2023</code> flag for this code to work.</p>

<pre><code>absl::optional<SkColor> BrowserFrame::GetUserColor() const {

#if BUILDFLAG(IS_CHROMEOS_ASH)
  // ChromeOS SystemWebApps use the OS theme all the time.
  if (ash::IsSystemWebApp(browser_view_->browser())) {
    return views::Widget::GetUserColor();
  }
#endif  // BUILDFLAG(IS_CHROMEOS_ASH)

  // Incognito profiles should always fall back to the material baseline.
  if (IsIncognitoBrowser()) {
    return absl::nullopt;
  }
  
++   content::WebContents* web_contents = browser_view_->browser()->tab_strip_model()->GetActiveWebContents();
++   
++   if (web_contents) {
++       absl::optional<SkColor> color = web_contents->GetThemeColor();
++       if (color){
++           if (color.has_value()) {
++               LOG(INFO) << "theme-color: " << std::hex << color.value() << std::setw(6) << std::setfill('0');
++               return SkColorSetA(color.value(), SK_AlphaOPAQUE);
++           }
++       }
++   }

  const auto* theme_service =
      ThemeServiceFactory::GetForProfile(browser_view_->browser()->profile());
  return theme_service->UsingAutogeneratedTheme()
             ? absl::optional<SkColor>(
                   theme_service->GetAutogeneratedThemeColor())
             : views::Widget::GetUserColor();
}</code></pre>

<p> This patch was made on commit <code>22be531a290d556fda7fa1b42d714265142cae55</code>. Hv Fun!! </p>


</div>